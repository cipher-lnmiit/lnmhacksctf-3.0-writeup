# STAGE 1: The Builder
FROM ubuntu:22.04 AS builder

# Install compiler tools
RUN apt-get update && apt-get install -y gcc make

WORKDIR /build

# Copy source and build
COPY challenge.c .
COPY Makefile .
RUN make

# STAGE 2: The Final Runtime
FROM ubuntu:22.04

# Install only what is needed to run
RUN apt-get update && apt-get install -y socat && rm -rf /var/lib/apt/lists/*

# Create limited user
RUN useradd -m ctf
WORKDIR /home/ctf

# Copy the binary from the STAGE 1 (builder)
COPY --from=builder /build/chronos_gamble .
# Copy the flag from your local folder
COPY flag.txt .

# Set strict professional permissions
RUN chown root:ctf /home/ctf/chronos_gamble && \
    chmod 111 /home/ctf/chronos_gamble && \
    chown root:ctf /home/ctf/flag.txt && \
    chmod 440 /home/ctf/flag.txt

USER ctf
EXPOSE 3012

# Execute via socat
CMD ["socat", "TCP-LISTEN:3012,reuseaddr,fork", "EXEC:./chronos_gamble,stderr"]
