#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <unistd.h>

// Professional Pwn Setup: Disable buffering and set a timeout
void setup() {
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);
    alarm(60); // Kill connection after 60 seconds to save server resources
}

void print_flag() {
    char ch;
    FILE *f = fopen("flag.txt", "r");
    if (f == NULL) {
        printf("Error: flag.txt is missing! If you are running this locally, create a dummy flag.\n");
        return;
    }
    while ((ch = fgetc(f)) != EOF) {
        putchar(ch);
    }
    putchar('\n');
    fclose(f);
}

int main() {
    setup();
    
    // The Vulnerability: Seeding with current time
    unsigned int seed = time(0);
    srand(seed);

    printf("--- THE CHRONOS GAMBLE ---\n");
    printf("I have seen the timeline. Can you match my vision?\n");
    printf("Predict the next 30 numbers to seize the flag.\n\n");

    for (int i = 0; i < 30; i++) {
        int target = rand() & 0xf; // Limit to 0-15
        int guess;
        
        printf("Iteration %d/30. Prediction: ", i + 1);
        
        if (scanf("%d", &guess) != 1) {
            printf("Invalid input. The timeline fractures.\n");
            return 1;
        }
        
        if (guess != target) {
            printf("Wrong! You are lost in time.\n");
            return 1;
        }
        printf("Correct!\n");
    }

    printf("You have mastered time itself.\n");
    print_flag();
    return 0;
}