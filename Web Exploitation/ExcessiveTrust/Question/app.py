from flask import Flask, render_template, request, redirect, session

app = Flask(__name__)
app.secret_key = "supersecretkey"

# ---------------- USERS ----------------
USERS = {
    "player": {
        "password": "player123",
        "credit": 100
    }
}

# ---------------- FLAG ----------------
FLAG = "LNMHACKS{bu15en355_vu1n3r4b1l17y}"

# ---------------- PRODUCTS ----------------
PRODUCTS = [
    {
        "id": 1,
        "name": "Lightweight l33t leather jacket",
        "price": 1000,
        "image": "https://images.unsplash.com/photo-1551028719-00167b16eac5?w=600&auto=format&fit=crop&q=60",
        "vulnerable": True
    },
    {
        "id": 2,
        "name": "Red Team Hoodie",
        "price": 150,
        "image": "https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=600&auto=format&fit=crop&q=60",
        "vulnerable": False
    },
    {
        "id": 3,
        "name": "CTF Sticker Pack",
        "price": 20,
        "image": "https://images.unsplash.com/photo-1540651810471-5699df74834f?w=600&auto=format&fit=crop&q=60",
        "vulnerable": False
    }
]

# ---------------- LOGIN ----------------
@app.route("/", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form.get("username")
        password = request.form.get("password")

        if username in USERS and USERS[username]["password"] == password:
            session["user"] = username
            return redirect("/shop")

        return "Invalid credentials"

    return render_template("login.html")

# ---------------- SHOP ----------------
@app.route("/shop", methods=["GET", "POST"])
def shop():
    if "user" not in session:
        return redirect("/")

    user = USERS[session["user"]]

    if request.method == "POST":
        product_id = int(request.form.get("product_id"))
        client_price = int(request.form.get("price"))

        product = next(p for p in PRODUCTS if p["id"] == product_id)

        # ❌ Vulnerable product
        if product["vulnerable"]:
            if client_price <= user["credit"]:
                return redirect("/success")
            else:
                return "Not enough credit"

        # ✅ Secure products
        else:
            if product["price"] <= user["credit"]:
                return "Purchased securely (no flag)"
            else:
                return "Not enough credit"

    return render_template(
        "shop.html",
        products=PRODUCTS,
        credit=user["credit"]
    )

# ---------------- SUCCESS ----------------
@app.route("/success")
def success():
    if "user" not in session:
        return redirect("/")
    return render_template("success.html", flag=FLAG)

# ---------------- RUN ----------------
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)

