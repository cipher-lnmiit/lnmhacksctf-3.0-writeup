import uuid
import unicodedata
import os
from flask import Flask, render_template, request, jsonify, session, render_template_string

app = Flask(__name__)
app.secret_key = os.urandom(24)

try:
    with open("flag.txt", "r") as f:
        app.config['sys_master_key'] = f.read().strip()
except FileNotFoundError:
    app.config['sys_master_key'] = "LNMHACKS{CONFIG_LOAD_ERROR}"

    app.config['debug_token'] = "LNMHACKS{DEV_TEST_TOKEN}"

db = {"users": {}}

def get_base_schema(uid):
    return {
        "uid": uid, 
        "profile": {"bio": "New Employee", "theme": "light_mode"},
        "role": "intern",
        "essence": 0
    }

def apply_updates(src, dst):
    for k, v in src.items():
        norm_k = unicodedata.normalize('NFKC', k)
        
        if isinstance(v, dict) and isinstance(dst.get(norm_k), dict):
            apply_updates(v, dst[norm_k])
        else:
            dst[norm_k] = v
    return dst

@app.before_request
def init_session():
    if "uid" not in session:
        uid = str(uuid.uuid4())
        session["uid"] = uid
        db["users"][uid] = get_base_schema(uid)

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/api/me', methods=['GET'])
def get_user_info():
    uid = session.get("uid")
    return jsonify(db["users"].get(uid))

@app.route('/api/v1/debug/elevate', methods=['POST'])
def enable_debug_mode():
    uid = session.get("uid")
    db["users"][uid]["role"] = "developer"
    return jsonify({"status": "ok", "mode": "developer"})

@app.route('/api/v1/update', methods=['POST'])
def update_user():
    uid = session.get("uid")
    user = db["users"].get(uid)
    payload = request.json
    
    if not payload: return jsonify({"error": "Empty payload"}), 400

    protected = ["role", "admin", "essence"]
    
    for k in payload.keys():
        if k in protected:
            return jsonify({"error": f"Field '{k}' is protected."}), 403

    apply_updates(payload, user)
    return jsonify({"status": "updated"})

@app.route('/dashboard', methods=['GET'])
def admin_panel():
    uid = session.get("uid")
    user = db["users"].get(uid)
    role = user.get("role")
    theme = user['profile'].get('theme', 'light_mode')

    if role == "developer":
        return render_template_string(f"<h2>Debug Mode Active</h2><p>Token: {app.config['debug_token']}</p>")

    if role == "admin":
        tpl = f"""
        <!DOCTYPE html>
        <html>
        <head><title>Admin Dashboard</title></head>
        <body>
            <h1>System Administration</h1>
            <p>Welcome, Administrator.</p>
            <p>Current Theme Configuration: {theme}</p>
            <hr>
            <p>System Status: Online</p>
        </body>
        </html>
        """
        return render_template_string(tpl)

    return "<h1>403 Forbidden</h1><p>Insufficient Privileges.</p>", 403

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)